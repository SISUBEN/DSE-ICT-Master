<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKDSE ICT - SQL 互動闖關練習</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alasql@1.7.3/dist/alasql.min.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .sql-editor { font-family: 'Courier New', Courier, monospace; width: 100%; resize: vertical; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { border: 1px solid #e5e7eb; padding: 8px 12px; text-align: left; }
        th { background-color: #f9fafb; font-weight: 600; color: #374151; }
        tr:nth-child(even) { background-color: #f9fafb; }
        tr:hover { background-color: #eff6ff; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        /* 任務列表動畫 */
        .mission-item { transition: all 0.2s; }
        .mission-item:hover { transform: translateX(4px); }
        .mission-active { border-left: 4px solid #2563eb; background-color: #eff6ff; }
        .mission-completed { border-left: 4px solid #10b981; opacity: 0.8; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- 頂部導航 -->
    <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center shrink-0 z-20">
        <div>
            <h1 class="text-xl font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                HKDSE SQL 闖關練習
            </h1>
            <p class="text-xs text-blue-200 mt-1">互動式任務系統 | 實戰數據庫操作</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-sm bg-blue-700 px-3 py-1 rounded-full">
                進度: <span id="progressText" class="font-bold text-yellow-300">0/6</span>
            </div>
            <button onclick="resetDatabase()" class="bg-blue-500 hover:bg-blue-400 text-white px-3 py-1 rounded text-sm transition flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                重置
            </button>
        </div>
    </header>

    <!-- 主要內容區 -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- 左側：資料庫架構 (Schema) -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col overflow-y-auto shrink-0 hidden md:flex">
            <div class="p-4 bg-gray-50 border-b border-gray-200 font-semibold text-gray-700 flex justify-between items-center">
                <span>資料表架構</span>
                <span class="text-xs text-gray-400">Schema</span>
            </div>
            <div class="p-4 space-y-6">
                <!-- Table: STUDENT -->
                <div>
                    <div class="font-bold text-blue-700 flex items-center gap-1 mb-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg>
                        STUDENT
                    </div>
                    <ul class="text-xs text-gray-600 space-y-1 pl-5 list-disc font-mono">
                        <li>sid (INT, PK)</li>
                        <li>name (VARCHAR)</li>
                        <li>gender (CHAR)</li>
                        <li>[class] (VARCHAR)</li>
                        <li>house (VARCHAR)</li>
                    </ul>
                </div>
                <!-- Table: CLUB -->
                <div>
                    <div class="font-bold text-blue-700 flex items-center gap-1 mb-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        CLUB
                    </div>
                    <ul class="text-xs text-gray-600 space-y-1 pl-5 list-disc font-mono">
                        <li>cid (VARCHAR, PK)</li>
                        <li>c_name (VARCHAR)</li>
                        <li>teacher (VARCHAR)</li>
                    </ul>
                </div>
                <!-- Table: MEMBERSHIP -->
                <div>
                    <div class="font-bold text-blue-700 flex items-center gap-1 mb-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                        </svg>
                        MEMBERSHIP
                    </div>
                    <ul class="text-xs text-gray-600 space-y-1 pl-5 list-disc font-mono">
                        <li>id (INT, PK)</li>
                        <li>student_id (FK)</li>
                        <li>club_id (FK)</li>
                        <li>role (VARCHAR)</li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- 中間：編輯器與結果 -->
        <section class="flex-1 flex flex-col min-w-0 bg-gray-100">
            <!-- 任務提示欄 -->
            <div id="missionBanner" class="bg-yellow-50 border-b border-yellow-200 p-4 text-sm text-yellow-800 flex justify-between items-start">
                <div>
                    <span class="font-bold bg-yellow-200 px-2 py-0.5 rounded text-yellow-800 text-xs uppercase tracking-wide mb-1 inline-block">Current Mission</span>
                    <h2 id="currentMissionTitle" class="font-bold text-lg text-gray-800">歡迎使用 SQL 練習場</h2>
                    <p id="currentMissionDesc" class="mt-1 text-gray-700">請從右側選擇一個任務開始，或在此自由編寫 SQL。</p>
                </div>
                <!-- 提示按鈕 -->
                <button onclick="toggleHint()" id="hintBtn" class="hidden text-xs text-yellow-600 hover:text-yellow-800 underline mt-1">
                    顯示提示
                </button>
            </div>
            <div id="hintBox" class="hidden bg-yellow-100 p-2 text-xs text-gray-600 border-b border-yellow-200 px-4">
                提示: <span id="hintText"></span>
            </div>

            <!-- 編輯器 -->
            <div class="bg-gray-800 p-4 shrink-0 shadow-inner">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-gray-300 text-sm font-semibold flex items-center gap-2">
                        SQL 查詢指令
                        <span class="text-xs font-normal text-gray-500">(支援 SELECT, JOIN, GROUP BY 等)</span>
                    </label>
                    <div class="flex gap-2">
                        <button onclick="runQuery(false)" class="bg-gray-600 hover:bg-gray-500 text-white text-sm font-bold py-1.5 px-4 rounded transition">
                            僅執行 (Run)
                        </button>
                        <button id="submitBtn" onclick="runQuery(true)" class="bg-green-600 hover:bg-green-500 text-white text-sm font-bold py-1.5 px-4 rounded shadow transition flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            提交驗證 (Submit)
                        </button>
                    </div>
                </div>
                <textarea id="sqlInput" class="sql-editor bg-gray-900 text-green-400 p-3 rounded border border-gray-700 focus:outline-none focus:border-blue-500 h-32 md:h-40 text-sm leading-relaxed" spellcheck="false" placeholder="-- 請在此輸入 SQL 指令..."></textarea>
            </div>

            <!-- 結果顯示區域 -->
            <div class="flex-1 bg-white p-4 overflow-hidden flex flex-col relative">
                <div class="flex justify-between items-center mb-2 shrink-0">
                    <h2 class="font-bold text-gray-700">執行結果</h2>
                    <span id="recordCount" class="text-sm text-gray-500"></span>
                </div>
                
                <!-- 狀態回饋框 (成功/失敗) -->
                <div id="feedbackBox" class="hidden mb-3 p-3 rounded text-sm flex items-center gap-2">
                    <!-- JS will inject content -->
                </div>

                <!-- 錯誤訊息框 (語法錯誤) -->
                <div id="errorBox" class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 p-3 mb-3 text-sm" role="alert">
                    <p class="font-bold">語法錯誤 (Syntax Error)</p>
                    <p id="errorMsg" class="font-mono mt-1">Something went wrong.</p>
                </div>

                <!-- 結果表格 -->
                <div class="table-container border border-gray-200 rounded flex-1 overflow-auto bg-white">
                    <table id="resultTable">
                        <thead class="bg-gray-50 sticky top-0 shadow-sm"></thead>
                        <tbody></tbody>
                    </table>
                    <div id="emptyState" class="p-12 text-center text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        <p>請輸入 SQL 並點擊「提交驗證」</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 右側：任務列表 -->
        <aside class="w-80 bg-white border-l border-gray-200 flex flex-col shrink-0 overflow-hidden shadow-xl z-10">
            <div class="p-4 bg-gray-50 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                <span>任務列表 (Missions)</span>
            </div>
            <div id="missionList" class="overflow-y-auto p-0 flex-1 bg-gray-50">
                <!-- JS will generate missions here -->
            </div>
        </aside>
    </main>

    <script>
        // 任務數據定義
        const missions = [
            {
                id: 0,
                title: "1. 初探資料庫 (SELECT)",
                desc: "列出所有學生的姓名 (name) 和班別 (class)。",
                hint: "使用 SELECT column1, column2 FROM table_name; 如果遇到保留字錯誤，請嘗試用 [class]。",
                answerSQL: "SELECT name, [class] FROM STUDENT",
                requiredKeywords: ["SELECT"],
                completed: false
            },
            {
                id: 1,
                title: "2. 條件篩選 (WHERE)",
                desc: "找出所有屬於 'Red' 社 (Red House) 的男學生 (gender = 'M')，列出所有資料。",
                hint: "使用 WHERE house = 'Red' AND gender = 'M'",
                answerSQL: "SELECT * FROM STUDENT WHERE house = 'Red' AND gender = 'M'",
                requiredKeywords: ["WHERE"],
                completed: false
            },
            {
                id: 2,
                title: "3. 排序資料 (ORDER BY)",
                desc: "列出所有學會的名稱 (c_name)，並按字母順序 (A-Z) 排列。",
                hint: "使用 ORDER BY c_name ASC",
                answerSQL: "SELECT c_name FROM CLUB ORDER BY c_name ASC",
                requiredKeywords: ["ORDER BY"],
                completed: false
            },
            {
                id: 3,
                title: "4. 跨表查詢 (JOIN)",
                desc: "列出 'Coding' 學會所有成員的學生姓名 (name) 及其擔任的職位 (role)。",
                hint: "需要連接 STUDENT, MEMBERSHIP 和 CLUB 三張表。",
                answerSQL: "SELECT S.name, M.role FROM STUDENT S JOIN MEMBERSHIP M ON S.sid = M.student_id JOIN CLUB C ON M.club_id = C.cid WHERE C.c_name = 'Coding'",
                requiredKeywords: ["JOIN"], // Code will handle "JOIN" OR comma
                completed: false
            },
            {
                id: 4,
                title: "5. 分組統計 (GROUP BY)",
                desc: "統計每個社 (house) 有多少名學生，顯示社別和人數 (count)。",
                hint: "使用 GROUP BY house 和 COUNT(*)",
                answerSQL: "SELECT house, COUNT(*) as count FROM STUDENT GROUP BY house",
                requiredKeywords: ["GROUP BY"],
                completed: false
            },
            {
                id: 5,
                title: "6. 進階篩選 (HAVING)",
                desc: "找出成員人數超過 2 人的學會 ID (club_id)，列出學會 ID。",
                hint: "先 GROUP BY club_id，再用 HAVING COUNT(*) > 2",
                answerSQL: "SELECT club_id FROM MEMBERSHIP GROUP BY club_id HAVING COUNT(*) > 2",
                requiredKeywords: ["HAVING"],
                completed: false
            }
        ];

        let currentMissionId = null;

        // 初始化資料庫
        function initDatabase() {
            try {
                // 使用 [class] 來避免關鍵字衝突 (DSE/Access 標準寫法)
                alasql('CREATE TABLE IF NOT EXISTS STUDENT (sid INT, name STRING, gender STRING, [class] STRING, house STRING)');
                alasql('CREATE TABLE IF NOT EXISTS CLUB (cid STRING, c_name STRING, teacher STRING)');
                alasql('CREATE TABLE IF NOT EXISTS MEMBERSHIP (id INT, student_id INT, club_id STRING, role STRING)');

                const students = [
                    {sid: 101, name: 'Chan Tai Man', gender: 'M', class: '6A', house: 'Red'},
                    {sid: 102, name: 'Wong Siu Yee', gender: 'F', class: '6A', house: 'Blue'},
                    {sid: 103, name: 'Lee Ka Ho', gender: 'M', class: '6B', house: 'Red'},
                    {sid: 104, name: 'Cheung Wai Ling', gender: 'F', class: '6B', house: 'Yellow'},
                    {sid: 105, name: 'Lau Chi Keung', gender: 'M', class: '6A', house: 'Green'},
                    {sid: 106, name: 'Ng Yan Ting', gender: 'F', class: '6C', house: 'Blue'},
                    {sid: 107, name: 'Ho Kwok Ming', gender: 'M', class: '6C', house: 'Yellow'},
                    {sid: 108, name: 'Ip Man', gender: 'M', class: '6A', house: 'Red'}
                ];
                
                const clubs = [
                    {cid: 'C01', c_name: 'Coding', teacher: 'Mr. Smith'},
                    {cid: 'C02', c_name: 'Chess', teacher: 'Ms. Wong'},
                    {cid: 'C03', c_name: 'Drama', teacher: 'Mr. Lee'}
                ];

                const members = [
                    {id: 1, student_id: 101, club_id: 'C01', role: 'Member'},
                    {id: 2, student_id: 101, club_id: 'C02', role: 'Chairman'},
                    {id: 3, student_id: 102, club_id: 'C01', role: 'Vice-Chairman'},
                    {id: 4, student_id: 103, club_id: 'C03', role: 'Member'},
                    {id: 5, student_id: 105, club_id: 'C01', role: 'Member'},
                    {id: 6, student_id: 108, club_id: 'C01', role: 'Treasurer'},
                    {id: 7, student_id: 104, club_id: 'C03', role: 'Secretary'},
                    {id: 8, student_id: 107, club_id: 'C02', role: 'Member'}
                ];

                alasql('INSERT INTO STUDENT SELECT * FROM ?', [students]);
                alasql('INSERT INTO CLUB SELECT * FROM ?', [clubs]);
                alasql('INSERT INTO MEMBERSHIP SELECT * FROM ?', [members]);

                console.log("Database initialized successfully.");
                renderMissionList();
            } catch (e) {
                console.error("Initialization Error:", e);
                document.getElementById('errorBox').classList.remove('hidden');
                document.getElementById('errorMsg').innerText = "Database Init Error: " + e.message;
            }
        }

        // 渲染任務列表
        function renderMissionList() {
            const list = document.getElementById('missionList');
            list.innerHTML = '';
            
            let completedCount = 0;

            missions.forEach((mission, index) => {
                if (mission.completed) completedCount++;

                const div = document.createElement('div');
                div.className = `mission-item p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 flex items-start justify-between group ${currentMissionId === index ? 'mission-active' : 'bg-white'} ${mission.completed ? 'mission-completed' : ''}`;
                div.onclick = () => selectMission(index);

                const icon = mission.completed 
                    ? `<span class="text-green-500 bg-green-100 rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></span>`
                    : `<span class="text-gray-400 bg-gray-100 rounded-full p-1 font-mono text-xs font-bold w-6 h-6 flex items-center justify-center">${index + 1}</span>`;

                div.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="mt-0.5">${icon}</div>
                        <div>
                            <h3 class="font-bold text-gray-800 text-sm group-hover:text-blue-600 transition">${mission.title}</h3>
                            <p class="text-xs text-gray-500 mt-1 line-clamp-1">${mission.desc}</p>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });

            document.getElementById('progressText').innerText = `${completedCount}/${missions.length}`;
        }

        // 選擇任務
        function selectMission(id) {
            currentMissionId = id;
            const mission = missions[id];
            
            // UI 更新
            renderMissionList();
            document.getElementById('currentMissionTitle').innerText = mission.title;
            document.getElementById('currentMissionDesc').innerText = mission.desc;
            document.getElementById('hintBtn').classList.remove('hidden');
            document.getElementById('hintBox').classList.add('hidden');
            document.getElementById('hintText').innerText = mission.hint;
            document.getElementById('sqlInput').value = ''; 
            document.getElementById('submitBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            
            // 清空結果
            document.getElementById('feedbackBox').className = 'hidden';
            document.querySelector('#resultTable thead').innerHTML = '';
            document.querySelector('#resultTable tbody').innerHTML = '';
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('recordCount').innerText = '';
        }

        function toggleHint() {
            const box = document.getElementById('hintBox');
            box.classList.toggle('hidden');
        }

        function resetDatabase() {
            alasql('DROP TABLE IF EXISTS STUDENT');
            alasql('DROP TABLE IF EXISTS CLUB');
            alasql('DROP TABLE IF EXISTS MEMBERSHIP');
            
            // Reset missions
            missions.forEach(m => m.completed = false);
            currentMissionId = null;
            
            // Reset UI
            document.getElementById('currentMissionTitle').innerText = "歡迎使用 SQL 練習場";
            document.getElementById('currentMissionDesc').innerText = "請從右側選擇一個任務開始，或在此自由編寫 SQL。";
            document.getElementById('hintBtn').classList.add('hidden');
            document.getElementById('hintBox').classList.add('hidden');
            document.querySelector('#resultTable thead').innerHTML = '';
            document.querySelector('#resultTable tbody').innerHTML = '';
            document.getElementById('recordCount').innerText = '';
            document.getElementById('feedbackBox').classList.add('hidden');
            document.getElementById('sqlInput').value = '';

            initDatabase();
        }

        // 執行查詢 (isSubmit: 是否為任務提交)
        function runQuery(isSubmit) {
            const sql = document.getElementById('sqlInput').value.trim();
            const errorBox = document.getElementById('errorBox');
            const errorMsg = document.getElementById('errorMsg');
            const feedbackBox = document.getElementById('feedbackBox');
            const tableHead = document.querySelector('#resultTable thead');
            const tableBody = document.querySelector('#resultTable tbody');
            const recordCount = document.getElementById('recordCount');
            const emptyState = document.getElementById('emptyState');

            // Reset UI states
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            errorBox.classList.add('hidden');
            feedbackBox.classList.add('hidden');
            recordCount.innerText = '';
            emptyState.classList.add('hidden');

            if (!sql) {
                emptyState.classList.remove('hidden');
                return;
            }

            try {
                // 1. 執行用戶的 SQL
                let userResult = alasql(sql);
                // 處理多語句 (取最後一個 SELECT 結果)
                if (Array.isArray(userResult) && userResult.length > 0 && Array.isArray(userResult[0])) {
                     const lastResult = userResult.reverse().find(r => Array.isArray(r));
                     userResult = lastResult || userResult[0];
                }

                // 2. 顯示結果表格
                if (Array.isArray(userResult)) {
                    renderTable(userResult, tableHead, tableBody);
                    recordCount.innerText = `返回 ${userResult.length} 筆記錄`;
                } else if (typeof userResult === 'number') {
                    recordCount.innerText = `操作成功，受影響行數: ${userResult}`;
                } else {
                    recordCount.innerText = "操作成功";
                }

                // 3. 如果是「提交驗證」，進行比對
                if (isSubmit && currentMissionId !== null) {
                    checkAnswer(userResult, sql);
                }

            } catch (e) {
                errorBox.classList.remove('hidden');
                errorMsg.innerText = e.message;
            }
        }

        // 答案檢查邏輯
        function checkAnswer(userResult, userSQL) {
            const mission = missions[currentMissionId];
            const feedbackBox = document.getElementById('feedbackBox');
            
            try {
                // 執行標準答案 (隱藏)
                const expectedResult = alasql(mission.answerSQL);
                
                // 比對邏輯
                let isCorrect = true;
                let failReason = "";

                // 1. 檢查行數 (Basic Check)
                if (!Array.isArray(userResult)) {
                    isCorrect = false;
                    failReason = "請使用 SELECT 語句查詢資料。";
                } else if (userResult.length !== expectedResult.length) {
                    isCorrect = false;
                    failReason = `結果數量不符。預期 ${expectedResult.length} 筆，實際 ${userResult.length} 筆。`;
                } else if (userResult.length > 0) {
                    // 2. 檢查欄位名稱 (Key Check)
                    const userKeys = Object.keys(userResult[0]).sort().join(',');
                    const expectedKeys = Object.keys(expectedResult[0]).sort().join(',');
                    
                    if (userKeys !== expectedKeys) {
                        isCorrect = false;
                        failReason = `欄位名稱不符。請檢查是否選擇了正確的欄位 (Columns)。`;
                    } else {
                        // 3. 檢查內容 (Content Check)
                        const sortFn = (a, b) => JSON.stringify(a).localeCompare(JSON.stringify(b));
                        const sortedUser = [...userResult].sort(sortFn);
                        const sortedExpected = [...expectedResult].sort(sortFn);

                        if (JSON.stringify(sortedUser) !== JSON.stringify(sortedExpected)) {
                            isCorrect = false;
                            failReason = "資料內容不符。請檢查篩選條件 (WHERE) 或 表連接 (JOIN) 是否正確。";
                        }
                        
                        // 4. 檢查排序 (Order Check)
                        if (mission.answerSQL.toUpperCase().includes("ORDER BY")) {
                             if (JSON.stringify(userResult) !== JSON.stringify(expectedResult)) {
                                 isCorrect = false;
                                 failReason = "資料正確但順序錯誤。請使用 ORDER BY 進行排序。";
                             }
                        }

                        // 5. 檢查關鍵字 (Method Check)
                        // 確保學生使用正確的語法達成目的，而不只是湊出數據
                        if (isCorrect && mission.requiredKeywords) {
                            const upperSQL = userSQL.toUpperCase();
                            const missingKeywords = [];
                            
                            mission.requiredKeywords.forEach(kw => {
                                // 針對 JOIN 的特殊處理：DSE 允許 "INNER JOIN" 或 "逗號"
                                if (kw === 'JOIN') {
                                    if (!upperSQL.includes('JOIN') && !upperSQL.includes(',')) {
                                        missingKeywords.push("JOIN (或使用逗號連接)");
                                    }
                                } else {
                                    if (!upperSQL.includes(kw)) {
                                        missingKeywords.push(kw);
                                    }
                                }
                            });

                            if (missingKeywords.length > 0) {
                                isCorrect = false;
                                failReason = `資料正確，但未運用指定的 SQL 語法：${missingKeywords.join(', ')}`;
                            }
                        }
                    }
                }

                feedbackBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                
                if (isCorrect) {
                    // 成功
                    feedbackBox.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
                    feedbackBox.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-bold">任務完成！</span> 答案正確。
                    `;
                    if (!missions[currentMissionId].completed) {
                        missions[currentMissionId].completed = true;
                        renderMissionList();
                    }
                } else {
                    // 失敗
                    feedbackBox.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
                    feedbackBox.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        <span><span class="font-bold">答案不正確：</span> ${failReason}</span>
                    `;
                }

            } catch (err) {
                console.error(err);
                feedbackBox.classList.remove('hidden');
                feedbackBox.classList.add('bg-red-100', 'text-red-800');
                feedbackBox.innerText = "驗證過程發生錯誤：" + err.message;
            }
        }

        function renderTable(data, thead, tbody) {
            if (data.length === 0) return;
            
            // Header
            const columns = Object.keys(data[0]);
            const trHead = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.innerText = col;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);

            // Body
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.opacity = '0';
                tr.style.animation = `fadeIn 0.3s forwards ${index * 0.05}s`;
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.innerText = row[col];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        const style = document.createElement('style');
        style.innerHTML = `@keyframes fadeIn { to { opacity: 1; } }`;
        document.head.appendChild(style);

        window.onload = initDatabase;

    </script>
</body>
</html>